<MudDialog>
    <DialogContent>
        <MudForm @ref="form" Model="Recipe">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="Recipe.Name" Label="Dish Name" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField @bind-Value="Recipe.CookTime" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.LockClock" Label="Cook Time" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField @bind-Value="Recipe.PrepTime" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.LockClock" Label="Preparation Time" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudNumericField @bind-Value="Recipe.Portion" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.SupervisorAccount" Label="Portions" Required="true" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="Recipe.Description" Label="Description" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Preparation Steps</MudText>
                    @for (int i = 0; i < PreparationSteps.Count; i++)
                    {
                        <MudTextField Adornment="Adornment.Start" AdornmentText="@($"{i + 1}.")" Value="PreparationSteps[i]" ValueChanged="@((string value) => OnStepChanged(value, i))"/>
                    }
                    <MudButton OnClick="@(AddToSteps)" ButtonType="ButtonType.Button">Add Step</MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Close">
            Close
        </MudButton>
        <MudButton OnClick="@Save">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; }

    private RecipeDto Recipe { get; set; } = new();
    private List<string> PreparationSteps { get; set; } = new();
    private MudForm form = new();

    private async Task Save()
    {
        await form.Validate();
        if (form.IsValid)
        {
            Recipe.CategoryId = 2;
            Recipe.Description = "";
            Recipe.Ingredients = new List<IngredientDto>() { new IngredientDto() { Id = 1, MaterialId = 1, Quantity = "3db" } };
            Recipe.ImageRef = "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=800&h=600&fit=crop";
            Recipe.PreparationSteps = string.Join(", ", PreparationSteps);
            await SwaggerClient.SaveAsync(Recipe);
            MudDialog.Close(DialogResult.Ok(Recipe));
        }
    }

    private async Task OnStepChanged(string step, int index)
    {
        PreparationSteps[index-1] = step;
    }

    private async Task AddToSteps()
    {
        PreparationSteps.Add("");
    }

    private async Task Close()
    {
        MudDialog.Close();
    }

}