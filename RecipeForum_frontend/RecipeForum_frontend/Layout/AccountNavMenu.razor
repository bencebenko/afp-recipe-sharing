@using Microsoft.AspNetCore.Components.Authorization 
@using RecipeForum_frontend.Infrastructure 
@using RecipeForum_frontend.Dialogs 
@inject AuthenticationStateProvider AuthProvider 
@inject IUserService userService 
@inject NavigationManager Navigation
@inject CategoryFilterState CategoryFilterState


<AuthorizeView>
    @* USER MENU *@ 
    <Authorized>
        <MudNavLink Href="/Profil" Icon="@Icons.Material.Filled.PersonOutline">Profile</MudNavLink>
        <MudNavLink OnClick="@(() => OpenAddRecipeDialog())" Icon="@Icons.Material.Filled.Upload">Add Recipe</MudNavLink>
        <MudNavLink Icon="@Icons.Material.Filled.Logout" OnClick=" Logout">Logout</MudNavLink>
    </Authorized> 

    @* GUEST MENU *@ 
    <NotAuthorized> 
        <MudNavLink OnClick="@(() => OpenRegisterDialog())" Icon="@Icons.Material.Filled.PersonAddAlt">Register</MudNavLink>
        <MudNavLink Href="/Account" Icon="@Icons.Material.Filled.Login">Login</MudNavLink> 
     </NotAuthorized> 
</AuthorizeView>

@code {
    private async Task Logout() 
    { 
        if (AuthProvider is CookieAuthenticationStateProvider cookieAuth)
        {
            await cookieAuth.MarkUserAsLoggedOut();
            Snackbar.Add("Logged out successfully.", Severity.Info);
            Navigation.NavigateTo("/");
        }
    } 

    private async Task OpenAddRecipeDialog()
    {
        var materials = await SwaggerClient.GetAllMaterialsAsync();
        var categories = await SwaggerClient.GetAllCategoriesAsync();

        var parameters = new DialogParameters()
        {
            ["Materials"] = materials.ToList(),
            ["Categories"] = categories.ToList()
        };

        var options = new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Add New Recipe", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            CategoryFilterState.ResetFilter();
            Snackbar.Add("Recipe added", Severity.Success);
            if (Navigation.ToBaseRelativePath(Navigation.Uri) != "")
            {
                Navigation.NavigateTo("/");
            }
        }
    }

    private async Task OpenRegisterDialog()
    {
        var parameters = new DialogParameters();

        var options = new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            CloseOnEscapeKey = true,
            FullWidth = true
        };
        var dialog = await DialogService.ShowAsync<RegisterDialog>("Register", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add("User registered", Severity.Success);
        }
    }
}