@page "/Profil"
@using RecipeForum_frontend.Dialogs
@using RecipeForum_frontend.Infrastructure
@using RecipeForum_frontend.Generated
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject IUserService userService
@inject SwaggerClient SwaggerClient
@inject AuthenticationStateProvider AuthStateProvider


<h3>Profil</h3>

@code {

    private bool isLoading = true;
    private List<RecipeDto> myRecipes = new();

    private bool IsUserLoggedIn = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var isAuth = authState.User?.Identity?.IsAuthenticated ?? false;

            var svcLoggedIn = false;
            try
            {
                svcLoggedIn = await userService.IsUserLoggedIn();
            }
            catch
            {

            }

            IsUserLoggedIn = isAuth || svcLoggedIn;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking auth state: {ex.Message}");
            try
            {
                IsUserLoggedIn = await userService.IsUserLoggedIn();
            }
            catch
            {
                IsUserLoggedIn = false;
            }
        }

        if (!IsUserLoggedIn) NavigationManager.NavigateTo("/login");

        await LoadMyRecipes();
    }


    private async Task LoadMyRecipes()
    {
        try
        {
            isLoading = true;
            var allRecipes = await SwaggerClient.GetAllAsync();
            myRecipes = allRecipes.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Hiba a receptek betöltésekor: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToRecipe(long recipeId)
    {
        NavigationManager.NavigateTo($"/Recipe/{recipeId}");
    }

    private async Task OpenEditRecipeDialog(RecipeDto recipe)
    {
        var parameters = new DialogParameters()
        {
            ["Recipe"] = recipe
        };
        var options = new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Edit Recipe", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadMyRecipes();
            Snackbar.Add("Recipe saved", Severity.Success);
        }
    }

    private async Task OpenDeleteDialog(long id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete recipe",
            "Are you sure you want to delete this recipe?",
            yesText: "Delete",
            cancelText: "Cancel",
            options: new DialogOptions { FullWidth = true, CloseOnEscapeKey = true, CloseButton = true });
        if (result.HasValue && result.Value)
        {
            await SwaggerClient.DeleteAsync(id);
            Snackbar.Add("Recipe deleted", Severity.Success);
            await LoadMyRecipes();
        }
    }

    private UserDto CurrentUser;

    private async Task GetCurrentUserAsync()
    {
        try
        {
            UserDto userDto = await SwaggerClient.GetCurrentUserAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Hiba a felhasználó adatainak betöltésekor: {ex.Message}");
        }
    }
}
