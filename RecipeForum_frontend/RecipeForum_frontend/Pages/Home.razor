@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using RecipeForum_frontend.Infrastructure
@using RecipeForum_frontend.Dialogs
@inject NavigationManager NavigationManager
@inject IUserService userService
@inject CategoryFilterState CategoryFilterState
@inject SearchState SearchState

<style>
    .card:hover{
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        cursor: pointer;
    }
</style>

<PageTitle>Home</PageTitle>

@if (true) @*Only if the user is logged in. Temporary place for the add recipe button only for testing, in "prod" iw will be up in the navbar*@
{
<MudGrid>
    <MudItem>
        <MudButton Variant="Variant.Filled" OnClick="@(() => OpenAddRecipeDialog())" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary">Add Recipe</MudButton>
    </MudItem>
</MudGrid>
<MudDivider Class="my-6" />
}

@if (CategoryFilterState.ShowFilter)
{
    <MudItem xs="12">
        <CategoryFilter Categories="categories"
                                    OnCategorySelected="OnCategoryChanged"
                                    OnCloseFilter="CategoryFilterState.ToggleFilter"/>
    </MudItem>
    <MudDivider Class="my-6" />
}

@if (recipes.Any())
{
    <MudGrid Class="d-flex flex-wrap">
    
        @foreach (RecipeDto item in recipes)
        {
            <MudItem xs="12" sm="4">
                <MudCard Class="card" onclick="@(() => NavigateToRecipe(item.Id))">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.body1">@item.Name</MudText>
                            <MudText Typo="Typo.body2">@($"{item.Portion} - {item.CookTime}")</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardMedia Image="@item.ImageRef"  Height="250" />
                    <MudCardActions>
                        <AuthorizeView>
                            <Authorized>
                                <MudTooltip Text="Like">
                                    <MudIconButton Icon="@Icons.Material.Filled.Favorite" Color="Color.Default" />
                                </MudTooltip>
                                <MudTooltip Text="More">
                                    <MudMenu Icon="@Icons.Material.Filled.Menu">
                                        <MudMenuItem Icon="@Icons.Material.Filled.FoodBank" OnClick="@(() => NavigateToRecipe(item.Id))">Details</MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" IconColor="Color.Secondary" OnClick="@(() => OpenEditRecipeDialog(item))">Edit</MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="@(() => OpenDeleteDialog(item.Id))">Delete</MudMenuItem>
                                    </MudMenu>
                                </MudTooltip>
                            </Authorized>
                            <NotAuthorized>
                                <MudButton StartIcon="@Icons.Material.Filled.FoodBank" OnClick="@(() => NavigateToRecipe(item.Id))">Details</MudButton>
                            </NotAuthorized>
                        </AuthorizeView>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}
else
{ 
        <MudItem xs="12" sm="6" md="4" Class="d-flex justify-content-center">
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Square="true" Class="my-2">No results found</MudAlert>
        </MudItem>
}
    
@code{
    private List<RecipeDto> recipes { get; set; } = new();
    private List<CategoryDto> categories = new();

    private List<RecipeDto> _allRecipesCache = new();
    private long? _currentSelectedCategoryId = null;
    private long? _lastCachedCategoryId = null;
    private long? SelectedCategoryId
    {
        get => _currentSelectedCategoryId;
        set => _currentSelectedCategoryId = value;
    }

    private bool IsLoggedIn = false;

    protected override async Task OnInitializedAsync()
    {
        CategoryFilterState.OnChange += StateHasChanged;
        CategoryFilterState.OnFilterReset += ResetAndLoadAll;
        SearchState.OnChange += OnSearchStateChanged;

        await LoadRecipesAsync();
        categories = (await SwaggerClient.GetAllCategoriesAsync()).ToList();
        IsLoggedIn = await userService.IsUserLoggedIn();
    }

    public void Dispose()
    {
        CategoryFilterState.OnChange -= StateHasChanged;
        CategoryFilterState.OnFilterReset -= ResetAndLoadAll;
        SearchState.OnChange -= OnSearchStateChanged;
    }

    private async void OnSearchStateChanged()
    {
        await FilterRecipesAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async void ResetAndLoadAll()
    {
        _currentSelectedCategoryId = null;
        await LoadRecipesAsync(forceApiCall: true);
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCategoryChanged(long? categoryId)
    {
        _currentSelectedCategoryId = categoryId;
        await LoadRecipesAsync(forceApiCall: true);
    }

    private async Task LoadRecipesAsync(bool forceApiCall = false)
    {
        bool isCacheInvalid = !_allRecipesCache.Any() || _currentSelectedCategoryId != _lastCachedCategoryId;
        if (forceApiCall || isCacheInvalid)
        {
            if (_currentSelectedCategoryId == null)
            {
                _allRecipesCache = (await SwaggerClient.GetAllAsync()).ToList();
            }
            else
            {
                _allRecipesCache = (await SwaggerClient.GetByCategoryAsync(_currentSelectedCategoryId.Value)).ToList();
            }
            _lastCachedCategoryId = _currentSelectedCategoryId;
        }
        await FilterRecipesAsync();
    }

    private Task FilterRecipesAsync()
    {
        string searchTerm = SearchState.CurrentSearchTerm?.Trim() ?? string.Empty;

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            recipes = _allRecipesCache
                .Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        else
        {
            recipes = _allRecipesCache.ToList();
        }

        return Task.CompletedTask;
    }

    private async Task OpenAddRecipeDialog()
    {
        var materials = await SwaggerClient.GetAllMaterialsAsync();
        var categories = await SwaggerClient.GetAllCategoriesAsync();
        var parameters = new DialogParameters()
        {
            ["Materials"] = materials.ToList(),
            ["Categories"] = categories.ToList()
        };

        var options = new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<AddRecipeDialog>("Add New Recipe", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadRecipesAsync(forceApiCall: true);
            Snackbar.Add("Recipe added", Severity.Success);
        }
    }

    private async Task OpenEditRecipeDialog(RecipeDto recipe)
    {
        var parameters = new DialogParameters()
        {
            ["Recipe"] = recipe
        };
        var options = new DialogOptions() 
        {
            CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true 
        };
        var dialog = await DialogService.ShowAsync<EditRecipeDialog>("Edit Recipe", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadRecipesAsync(forceApiCall: true);
            Snackbar.Add("Recipe saved", Severity.Success);
        }
    }

    private async Task OpenDeleteDialog(long id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete recipe",
            "Are you sure you want to delete this recipe?",
            yesText: "Delete", 
            cancelText: "Cancel", 
            options: new DialogOptions { FullWidth = true, CloseOnEscapeKey = true, CloseButton = true });
        if (result.HasValue && result.Value)
        {
            await SwaggerClient.DeleteAsync(id);
            Snackbar.Add("Recipe deleted", Severity.Success);
            await LoadRecipesAsync(forceApiCall: true);
        }
    }

    private async Task NavigateToRecipe(long recipeId)
    {
        NavigationManager.NavigateTo($"/Recipe/{recipeId}");
    }
} 